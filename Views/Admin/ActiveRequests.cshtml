@model IEnumerable<dynamic>

@{
    ViewData["Title"] = "Active Service Requests";
}

<div class="container-fluid py-4 px-4">
    <div class="d-flex align-items-center mb-4">
        <i class="bi bi-list-ul fs-3 me-3" style="color: #28a745;"></i>
        <h3 class="mb-0 fw-bold" style="color: #1b5e20;">Active Service Requests</h3>
    </div>

    <div class="card shadow-sm border-0 rounded-3">
        <div class="table-responsive">
            <table class="table align-middle mb-0 custom-request-table">
                <thead style="background-color: #f1f8e9;">
                    <tr>
                        <th class="ps-4 text-muted fw-bold text-uppercase" style="width: 100px; font-size: 0.9rem;">Req #</th>
                        <th class="text-muted fw-bold text-uppercase" style="width: 280px; font-size: 0.9rem;">Resident Name</th>
                        <th class="text-muted fw-bold text-uppercase" style="width: 220px; font-size: 0.9rem;">Document</th>
                        <th class="text-muted fw-bold text-uppercase" style="width: 200px; font-size: 0.9rem;">Status</th>
                        <th class="text-muted fw-bold text-uppercase" style="font-size: 0.9rem;">Update Status & Set Schedule</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1"></i>
                                <p class="mt-2 fs-5">No active service requests found.</p>
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in Model)
                        {
                            <tr class="border-bottom">
                                <td class="ps-4 fw-bold text-dark fs-5">#@item.Request.RequestId</td>
                                <td>
                                    <div class="fw-bold text-dark fs-5">@item.ResidentName</div>
                                    <div class="d-flex align-items-center @(item.User?.IsActive == false ? "text-danger" : "text-success")" style="font-size: 0.9rem; font-weight: 500;">
                                        <i class="bi bi-circle-fill me-2" style="font-size: 8px;"></i>
                                        @(item.User?.IsActive == false ? "Inactive" : "Active")
                                    </div>
                                </td>
                                <td>
                                    
                                    <button class="btn btn-outline-success btn-md rounded-1 px-3 fw-bold" style="font-size: 0.85rem; pointer-events: none; border-width: 2px; color: #28a745; border-color: #28a745;">
                                        @item.RequestedDocument
                                    </button>
                                </td>
                                <td>
                                    @{
                                        var statusName = ((string)item.CurrentStatusName).ToUpper();
                                        var badgeClass = statusName switch
                                        {
                                            "REJECTED" => "bg-danger",
                                            "PENDING" => "bg-secondary",
                                            "APPROVED" => "bg-success",
                                            "PICKED UP" => "bg-info",
                                            "READY TO CLAIM" => "bg-info",
                                            _ => "bg-dark"
                                        };
                                    }
                                    <span class="badge @badgeClass mb-2 px-3 py-2" style="font-size: 0.85rem; letter-spacing: 0.5px; border-radius: 6px;">@statusName</span>

                                    @if (item.Request.DateToClaim != null)
                                    {
                                        <div class="text-dark d-flex align-items-center fw-medium" style="font-size: 0.95rem; line-height: 1.5;">
                                            <i class="bi bi-calendar3 me-2" style="color: #28a745;"></i> @item.Request.DateToClaim.ToString("MM/dd/yyyy")
                                        </div>
                                        <div class="text-dark d-flex align-items-center fw-medium" style="font-size: 0.95rem;">
                                            <i class="bi bi-clock me-2" style="color: #28a745;"></i> @(DateTime.Today.Add(item.Request.TimeToClaim).ToString("hh:mm tt"))
                                        </div>
                                    }
                                </td>
                                <td class="pe-4">
                                    <form asp-controller="Admin" asp-action="UpdateStatus" method="post" class="d-flex align-items-center gap-3">
                                        <input type="hidden" name="requestId" value="@item.Request.RequestId" />

                                        <div class="flex-grow-1" style="max-width: 300px;">
                                            <select name="newStatusId" class="form-select mb-2 bg-white border-2" style="font-size: 0.95rem; height: 42px;" required>
                                                <option value="" disabled selected>Select Status</option>
                                                @foreach (var status in (IEnumerable<FPSample.Models.Entities.Status>)ViewBag.StatusList)
                                                {
                                                    <option value="@status.StatusId" selected="@(status.StatusId == item.Request.StatusId)">
                                                        @status.StatusName
                                                    </option>
                                                }
                                            </select>
                                            <div class="d-flex gap-2">
                                                <div class="input-group">
                                                    <input type="date" name="claimDate" class="form-control border-2" style="font-size: 0.9rem;" value="@(item.Request.DateToClaim?.ToString("yyyy-MM-dd"))" />
                                                </div>
                                                <div class="input-group">
                                                    <input type="time" name="claimTime" class="form-control border-2" style="font-size: 0.9rem;" value="@(item.Request.TimeToClaim.ToString(@"hh\:mm"))" />
                                                </div>
                                            </div>
                                        </div>

                                        
                                        <button type="submit" class="btn btn-success shadow-sm d-flex align-items-center justify-content-center text-white border-0"
                                                style="width: 50px; height: 85px; border-radius: 10px; background-color: #28a745;">
                                            <i class="bi bi-check-lg fs-3"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .custom-request-table thead th {
        padding-top: 20px;
        padding-bottom: 20px;
    }

    .custom-request-table tbody td {
        padding-top: 25px;
        padding-bottom: 25px;
    }

    .custom-request-table tr:hover {
        background-color: #f1f8e9; 
    }

    .form-select, .form-control {
        border-radius: 8px !important;
    }

        .form-control:focus, .form-select:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.15);
        }

    .btn-outline-success:hover {
        background-color: transparent !important;
        color: #28a745 !important;
        border-color: #28a745 !important;
    }
</style>